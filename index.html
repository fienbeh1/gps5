<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Logger</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #111; color: white; margin: 0; }
        .box { background: #222; padding: 30px; border-radius: 15px; text-align: center; border: 1px solid #444; width: 90%; }
        button { background: #3ecf8e; color: #111; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
        #log { margin-top: 20px; font-size: 12px; color: #888; word-break: break-all; }
    </style>
</head>
<body>

<div class="box">
    <h2>Record Connection</h2>
    <button id="btn">SEND DATA TO DB</button>
    <div id="log">Ready.</div>
</div>

<script>
    const SB_URL = "https://yigmlvoyihpimgvpntlx.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpZ21sdm95aWhwaW1ndnBudGx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwOTEwMzksImV4cCI6MjA4MjY2NzAzOX0.fjChTuOhD6fFKqh4ZEK0TPt2BO8c8y_j05uslfkDCko";

    document.getElementById('btn').onclick = async () => {
        const log = document.getElementById('log');
        log.textContent = "Requesting GPS...";

        try {
            // 1. Get GPS
            const pos = await new Promise((res, rej) => {
                navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true });
            });

            // 2. Get IP Info
            log.textContent = "Getting Network Info...";
            const ipRes = await fetch('https://ipapi.co/json/');
            const d = await ipRes.json();

            // 3. Format JSONB
            const jsonb = {
                "ip": d.ip,
                "isp": { "asn": d.asn, "org": d.org, "isp": d.org },
                "location": {
                    "country": d.country_name, "country_code": d.country_code,
                    "city": d.city, "state": d.region, "zipcode": d.postal,
                    "latitude": pos.coords.latitude, "longitude": pos.coords.longitude,
                    "timezone": d.timezone, "localtime": new Date().toISOString()
                },
                "risk": { "is_mobile": true, "is_vpn": false, "risk_score": 0 }
            };

            // 4. Send to Supabase
            log.textContent = "Saving to Database...";
            const save = await fetch(`${SB_URL}/rest/v1/geo_logs`, {
                method: 'POST',
                headers: {
                    'apikey': SB_KEY,
                    'Authorization': `Bearer ${SB_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    ip_address: d.ip,
                    full_data: jsonb,
                    status: 'procesado'
                })
            });

            if (save.ok) {
                log.innerHTML = "✅ SUCCESS!<br>Data saved to DB.";
                alert("Captured: " + d.ip + " @ " + pos.coords.latitude);
            } else {
                throw new Error("DB Save Failed");
            }

        } catch (e) {
            log.innerHTML = "❌ ERROR: " + e.message + "<br>Check if HTTPS is active.";
        }
    };
</script>
</body>
</html>
