async function startCapture() {
    const log = document.getElementById('log');
    log.textContent = "Initializing GPS hardware...";

    // This function wraps the GPS call in a 10-second "race"
    const getCoords = () => {
        return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve(pos),
                (err) => reject(err),
                {
                    enableHighAccuracy: true, // Try GPS first
                    timeout: 10000,           // Give up after 10 seconds
                    maximumAge: 0
                }
            );
        });
    };

    try {
        const position = await getCoords();
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        log.textContent = `GPS Locked (${lat.toFixed(4)}). Fetching IP...`;

        // 2. Get IP Info
        const ipRes = await fetch('https://ipapi.co/json/');
        const d = await ipRes.json();

        // 3. Structure JSONB (Your Format)
        const jsonb = {
            "ip": d.ip,
            "isp": { "asn": d.asn, "org": d.org, "isp": d.org },
            "location": {
                "country": d.country_name, "country_code": d.country_code,
                "city": d.city, "state": d.region, "zipcode": d.postal,
                "latitude": lat, 
                "longitude": lon,
                "timezone": d.timezone, "localtime": new Date().toISOString()
            },
            "risk": { "is_mobile": true, "is_vpn": false, "risk_score": 0 }
        };

        // 4. Send to Supabase
        const save = await fetch(`${SB_URL}/rest/v1/geo_logs`, {
            method: 'POST',
            headers: {
                'apikey': SB_KEY,
                'Authorization': `Bearer ${SB_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ip: d.ip,
                data: jsonb,
                status: 'procesado',
                bloque_origen: text
            })
        });

        if (save.ok) log.innerHTML = "✅ SAVED TO DB";
        else log.innerHTML = "❌ DB SAVE FAILED";

    } catch (e) {
        console.error(e);
        log.innerHTML = "❌ ERROR: " + e.message + "<br><br>Check if Location is ON in phone settings.";
    }
}
