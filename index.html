<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPv4 GPS Logger</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; padding: 20px; }
        .card { background: #1e1e1e; padding: 25px; border-radius: 15px; border: 1px solid #333; max-width: 400px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        button { background: #3ecf8e; color: #121212; border: none; padding: 18px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 16px; }
        #log { margin-top: 20px; font-family: monospace; font-size: 11px; color: #00ff00; background: #000; padding: 12px; border-radius: 5px; text-align: left; min-height: 100px; border: 1px solid #333; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color:#3ecf8e">System Logger</h2>
    <button onclick="processData()">CAPTURE & SAVE</button>
    <div id="log">Ready to capture...</div>
</div>

<script>
    // 1. YOUR CREDENTIALS
    const SB_URL = "YOUR_SUPABASE_URL"; 
    const SB_KEY = "YOUR_SUPABASE_ANON_KEY";

    async function processData() {
        const log = document.getElementById('log');
        log.textContent = ">>> Accessing GPS Hardware...";

        try {
            // 2. Get Real GPS Coordinates
            const pos = await new Promise((res, rej) => {
                navigator.geolocation.getCurrentPosition(res, rej, { 
                    enableHighAccuracy: true, 
                    timeout: 10000 
                });
            });

            log.textContent += "\n>>> Forcing IPv4 Lookup...";

            // 3. Get IPv4 and ISP Data
            // We use 'ipv4.icanhazip.com' to ensure we don't get the IPv6
            const [ipv4, geoRes] = await Promise.all([
                fetch('https://ipv4.icanhazip.com').then(r => r.text()),
                fetch('https://ipapi.co/json/').then(r => r.json())
            ]);

            const cleanIPv4 = ipv4.trim();

            // 4. Structure JSONB (Your Format)
            const jsonb = {
                "ip": cleanIPv4,
                "isp": { 
                    "asn": geoRes.asn, 
                    "isp": geoRes.org, 
                    "org": geoRes.org 
                },
                "location": {
                    "country": geoRes.country_name,
                    "country_code": geoRes.country_code,
                    "city": geoRes.city,
                    "state": geoRes.region,
                    "zipcode": geoRes.postal,
                    "latitude": pos.coords.latitude,
                    "longitude": pos.coords.longitude,
                    "timezone": geoRes.timezone,
                    "localtime": new Date().toISOString()
                },
                "risk": { 
                    "is_mobile": true, 
                    "is_vpn": false, 
                    "risk_score": 0 
                }
            };

            log.textContent += "\n>>> Connecting to Supabase...";

            // 5. Send to DB with your specific headers
            const save = await fetch(`${SB_URL}/rest/v1/geo_logs`, {
                method: 'POST',
                headers: {
                    'apikey': SB_KEY,
                    'Authorization': `Bearer ${SB_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    ip: cleanIPv4,        // Column: ip
                    data: jsonb,          // Column: data
                    status: 'procesado',  // Column: status
                    bloque_origen: cleanIPv4 // Column: bloque_origen
                })
            });

            if (save.ok) {
                log.innerHTML = `<span style="color:#3ecf8e">>>> ✅ RECORD SAVED</span>\n\nIPv4: ${cleanIPv4}\nGPS: ${pos.coords.latitude}, ${pos.coords.longitude}\nStatus: procesado`;
            } else {
                const err = await save.text();
                throw new Error("DB Save Failed: " + err);
            }

        } catch (e) {
            log.innerHTML = `<span style="color:#ff453a">>>> ❌ ERROR</span>\n${e.message}`;
        }
    }
</script>
</body>
</html>
